<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geminiì™€ í•¨ê»˜í•˜ëŠ” ë‚ ì”¨ ë¹„êµ (Netlify ë²„ì „)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white border-2 border-blue-300 rounded-2xl shadow-lg p-6 sm:p-8 max-w-2xl w-full text-center">
        <h1 class="text-4xl sm:text-5xl font-black text-blue-900 leading-tight mb-4">
            <span class="flex items-baseline justify-center gap-x-1"><span>ì–´ì œ</span><span class="text-3xl sm:text-4xl font-semibold">ë³´ë‹¤</span><span>ì˜¤ëŠ˜</span></span>
        </h1>
        <p class="text-gray-600 mb-2">
            <span class="font-bold">ğŸ“ í˜„ì¬ ìœ„ì¹˜:</span> <span id="location-display">ìœ„ì¹˜ ì •ë³´ ë¡œë”© ì¤‘...</span> (<span id="time-display">--:--</span> ê¸°ì¤€)
        </p>
        <div id="manual-location-container" class="mt-2 hidden">
            <input type="text" id="manual-location-input" placeholder="ë„ì‹œ ì´ë¦„ ì…ë ¥ (ì˜ˆ: ì„œìš¸)" class="border rounded-md p-2 w-full sm:w-2/3">
            <button id="manual-location-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mt-2 sm:mt-0 sm:ml-2 transition-colors">í™•ì¸</button>
        </div>
        <p id="error-message" class="text-red-500 text-sm mt-1 mb-2 hidden"></p>
        <div class="bg-gray-100 rounded-lg p-3 mb-6">
            <h3 class="font-bold text-gray-700 text-sm mb-1">ì˜¤ëŠ˜ì˜ í˜„ì¬ ì´ ì‹œê° ë‚ ì”¨</h3>
            <div class="flex items-center justify-center gap-x-2">
                <span id="weather-icon" class="text-3xl">ğŸ¤”</span>
                <span id="weather-description" class="text-lg font-semibold text-gray-800">ë‚ ì”¨ ì •ë³´ ë¡œë”© ì¤‘...</span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse" id="weather-table">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border border-gray-300 p-3 text-sm sm:text-base font-bold text-gray-700">ë‚ ì§œ</th>
                        <th class="border border-gray-300 p-3 text-sm sm:text-base font-bold text-gray-700">í‰ê·  ê¸°ì˜¨ (Â°C)</th>
                        <th class="border border-gray-300 p-3 text-sm sm:text-base font-bold text-gray-700">ì²´ê° ì˜¨ë„ (Â°C)</th>
                        <th class="border border-gray-300 p-3 text-sm sm:text-base font-bold text-gray-700">í’ì† (m/s)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="border border-gray-300 p-3"><span class="font-bold">ì–´ì œ</span><br><span id="yesterday-date" class="text-sm text-gray-500"></span></td>
                        <td id="yesterday-temp" class="border border-gray-300 p-3 text-lg">-</td>
                        <td id="yesterday-feels-like" class="border border-gray-300 p-3 text-lg">-</td>
                        <td id="yesterday-wind-speed" class="border border-gray-300 p-3 text-lg">-</td>
                    </tr>
                    <tr class="bg-yellow-100">
                        <td class="border border-gray-300 p-3 font-bold"><span>ì˜¤ëŠ˜</span><br><span id="today-date" class="text-sm text-gray-600"></span></td>
                        <td id="today-temp" class="border border-gray-300 p-3 text-xl font-bold text-red-600">-</td>
                        <td id="today-feels-like" class="border border-gray-300 p-3 text-xl font-bold text-red-600">-</td>
                        <td id="today-wind-speed" class="border border-gray-300 p-3 text-xl font-bold text-blue-600">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p id="comparison-message" class="text-red-500 text-2xl font-bold mt-8 mb-6">ë‚ ì”¨ ì •ë³´ë¥¼ ë¹„êµ ì¤‘ì…ë‹ˆë‹¤...</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button id="clothing-suggestion-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 opacity-50 cursor-not-allowed" disabled>âœ¨ ì˜¤ëŠ˜ ë­ ì…ì„ê¹Œ?</button>
            <button id="activity-suggestion-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 opacity-50 cursor-not-allowed" disabled>âœ¨ ì˜¤ëŠ˜ ë­ í• ê¹Œ?</button>
        </div>
        <div id="suggestion-container" class="mt-6 hidden">
            <div id="loader" class="loader hidden"></div>
            <div id="suggestion-result" class="text-left bg-gray-50 p-4 rounded-lg border border-gray-200 whitespace-pre-wrap"></div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const clothingBtn = document.getElementById('clothing-suggestion-btn');
        const activityBtn = document.getElementById('activity-suggestion-btn');
        const suggestionContainer = document.getElementById('suggestion-container');
        const loader = document.getElementById('loader');
        const suggestionResult = document.getElementById('suggestion-result');
        const locationDisplay = document.getElementById('location-display');
        const timeDisplay = document.getElementById('time-display');
        const weatherIcon = document.getElementById('weather-icon');
        const weatherDescription = document.getElementById('weather-description');
        const yesterdayDateEl = document.getElementById('yesterday-date');
        const todayDateEl = document.getElementById('today-date');
        const errorMessageEl = document.getElementById('error-message');
        const manualLocationContainer = document.getElementById('manual-location-container');
        const manualLocationInput = document.getElementById('manual-location-input');
        const manualLocationBtn = document.getElementById('manual-location-btn');
        const yesterdayTempEl = document.getElementById('yesterday-temp');
        const yesterdayFeelsLikeEl = document.getElementById('yesterday-feels-like');
        const yesterdayWindSpeedEl = document.getElementById('yesterday-wind-speed');
        const todayTempEl = document.getElementById('today-temp');
        const todayFeelsLikeEl = document.getElementById('today-feels-like');
        const todayWindSpeedEl = document.getElementById('today-wind-speed');
        const comparisonMessageEl = document.getElementById('comparison-message');
        
        // --- API Keys are now on the server (Netlify Function) ---

        window.onload = function() {
            updateDateTime();
            getLocation();
            manualLocationBtn.addEventListener('click', () => {
                const location = manualLocationInput.value.trim();
                if (location) {
                    errorMessageEl.classList.add('hidden');
                    manualLocationContainer.classList.add('hidden');
                    fetchAndDisplayWeather(location, location);
                } else {
                    showError("ë„ì‹œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                }
            });
        };

        function updateDateTime() {
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            const options = { weekday: 'short' };
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timeDisplay.textContent = `${hours}:${minutes}`;
            const formatDate = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} (${date.toLocaleDateString('ko-KR', options)})`;
            todayDateEl.textContent = formatDate(now);
            yesterdayDateEl.textContent = formatDate(yesterday);
        }

        function getLocation() {
            if (navigator.geolocation) {
                locationDisplay.textContent = "ë¸Œë¼ìš°ì €ì˜ ìœ„ì¹˜ ì •ë³´ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”...";
                navigator.geolocation.getCurrentPosition(handlePositionSuccess, handleLocationError, { timeout: 10000 });
            } else {
                handleLocationError({ code: -1, message: "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
            }
        }

        async function handlePositionSuccess(position) {
            const { latitude, longitude } = position.coords;
            const locationQuery = `${latitude},${longitude}`;
            const koreanLocationName = await getKoreanLocationName(latitude, longitude);
            fetchAndDisplayWeather(locationQuery, koreanLocationName);
        }

        async function getKoreanLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=ko`;
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                const address = data.address;
                const city = address.city || address.town || address.county || '';
                const suburb = address.suburb || '';
                return (city && suburb && city !== suburb) ? `${city} ${suburb}` : city || null;
            } catch (error) {
                console.error("Error fetching Korean location name:", error);
                return null;
            }
        }

        async function fetchAndDisplayWeather(query, koreanName = null) {
            locationDisplay.textContent = "ë‚ ì”¨ ì •ë³´ ë¡œë”© ì¤‘...";
            weatherIcon.textContent = 'ğŸ¤”';
            weatherDescription.textContent = 'ë‚ ì”¨ ì •ë³´ ë¡œë”© ì¤‘...';

            try {
                const response = await fetch('/.netlify/functions/weather', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'weather', query: query })
                });
                
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || "ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }

                const todayData = data.today;
                const yesterdayData = data.yesterday;

                locationDisplay.textContent = koreanName || todayData.location.name;
                const { emoji, desc } = getEmoji(todayData.current.condition.text);
                weatherIcon.textContent = emoji;
                weatherDescription.textContent = desc;

                const todayTemp = todayData.current.temp_c;
                const todayFeels = todayData.current.feelslike_c;
                const todayWindMps = (todayData.current.wind_kph / 3.6).toFixed(1);
                
                const yesterdayForecast = yesterdayData.forecast.forecastday[0];
                const yesterdayTemp = yesterdayForecast.day.avgtemp_c;
                const yesterdayWindMps = (yesterdayForecast.day.maxwind_kph / 3.6).toFixed(1);
                const yesterdayFeelsLikeAvg = yesterdayForecast.hour.reduce((sum, hour) => sum + hour.feelslike_c, 0) / yesterdayForecast.hour.length;

                todayTempEl.textContent = todayTemp.toFixed(1);
                todayFeelsLikeEl.textContent = todayFeels.toFixed(1);
                todayWindSpeedEl.textContent = todayWindMps;
                yesterdayTempEl.textContent = yesterdayTemp.toFixed(1);
                yesterdayFeelsLikeEl.textContent = yesterdayFeelsLikeAvg.toFixed(1);
                yesterdayWindSpeedEl.textContent = yesterdayWindMps;

                if (todayTemp > yesterdayTemp) comparisonMessageEl.innerHTML = "ì˜¤ëŠ˜ì´ ë” ë”ì›Œìš” ğŸ”¥";
                else if (todayTemp < yesterdayTemp) comparisonMessageEl.innerHTML = "ì–´ì œê°€ ë” ë”ì› ì–´ìš” ğŸŒ™";
                else comparisonMessageEl.innerHTML = "ì–´ì œì™€ ì˜¤ëŠ˜ ê¸°ì˜¨ì´ ë¹„ìŠ·í•´ìš” ğŸ˜";
                
                enableButtons();

            } catch (error) {
                console.error("Weather fetch error:", error);
                showError(error.message);
                handleLocationError();
            }
        }

        function getEmoji(condition) {
            if (!condition) return { emoji: 'â“', desc: 'ì•Œ ìˆ˜ ì—†ìŒ' };
            const lc = condition.toLowerCase(); 
            const ko = condition; 

            if (lc.includes("fog") || lc.includes("mist") || lc.includes("haze") || ko.includes("ì•ˆê°œ")) return { emoji: "ğŸŒ«ï¸", desc: "ì•ˆê°œ/ì˜…ì€ ì•ˆê°œ" };
            if (lc.includes("sunny") || lc.includes("clear") || ko.includes("ë§‘ìŒ")) return { emoji: "â˜€ï¸", desc: "ë§‘ìŒ" };
            if (lc.includes("partly") && lc.includes("cloud")) return { emoji: "â›…", desc: "êµ¬ë¦„ ì¡°ê¸ˆ" };
            if (lc.includes("cloudy") || ko.includes("íë¦¼")) return { emoji: "â˜ï¸", desc: "íë¦¼" };
            if (lc.includes("overcast") || ko.includes("êµ¬ë¦„ ë§ìŒ")) return { emoji: "ğŸŒ¥ï¸", desc: "êµ¬ë¦„ ë§ìŒ" };
            if (lc.includes("patchy rain") || lc.includes("light rain") || ko.includes("ê°€ë²¼ìš´ ë¹„")) return { emoji: "ğŸŒ¦ï¸", desc: "ì•½í•œ ë¹„" };
            if (lc.includes("rain") || ko.includes("ë¹„")) return { emoji: "ğŸŒ§ï¸", desc: "ë¹„" };
            if (lc.includes("snow") && lc.includes("light") || ko.includes("ê°€ë²¼ìš´ ëˆˆ")) return { emoji: "ğŸŒ¨ï¸", desc: "ì•½í•œ ëˆˆ" };
            if (lc.includes("snow") || ko.includes("ëˆˆ")) return { emoji: "â„ï¸", desc: "ëˆˆ" };
            if (lc.includes("thunder") || ko.includes("ë‡Œìš°")) return { emoji: "â›ˆï¸", desc: "ì²œë‘¥ ë²ˆê°œ" };
            
            return { emoji: "ğŸŒ¡ï¸", desc: condition };
        }

        function handleLocationError(error) {
            let message = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë„ì‹œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            if (error) {
                switch(error.code) {
                    case error.PERMISSION_DENIED: message = "ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë„ì‹œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; break;
                    case error.POSITION_UNAVAILABLE: message = "í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë„ì‹œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; break;
                    case error.TIMEOUT: message = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë„ì‹œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."; break;
                }
            }
            showError(message);
            locationDisplay.textContent = "ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€";
            manualLocationContainer.classList.remove('hidden');
        }

        function showError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
        }

        function enableButtons() {
            [clothingBtn, activityBtn].forEach(btn => {
                btn.disabled = false;
                btn.classList.remove("opacity-50", "cursor-not-allowed");
            });
        }

        clothingBtn.addEventListener('click', () => handleSuggestion('clothing'));
        activityBtn.addEventListener('click', () => handleSuggestion('activity'));

        function handleSuggestion(type) {
            const temp = todayTempEl.innerText;
            const feelsLike = todayFeelsLikeEl.innerText;
            const windSpeed = todayWindSpeedEl.innerText;
            const location = locationDisplay.innerText;
            const weather = weatherDescription.innerText;
            let prompt;
            if (type === 'clothing') {
                prompt = `í˜„ì¬ ${location}ì˜ ê¸°ì˜¨ì´ ${temp}Â°C, ì²´ê°ì˜¨ë„ëŠ” ${feelsLike}Â°C, í’ì†ì€ ${windSpeed}m/sì´ê³ , ë‚ ì”¨ëŠ” '${weather}' ì…ë‹ˆë‹¤. ì´ ë‚ ì”¨ì— ë‚¨ì„±ê³¼ ì—¬ì„±ì´ ì…ê¸° ì¢‹ì€ ì˜·ì°¨ë¦¼ì„ ê°ê° ì¶”ì²œí•´ì£¼ì„¸ìš”. ë‹µë³€ì€ í•œêµ­ì–´ë¡œ, ê°„ë‹¨í•˜ê³  ëª…ë£Œí•˜ê²Œ í•­ëª©ìœ¼ë¡œ êµ¬ë¶„í•´ì„œ ì œì•ˆí•´ì¤˜.`;
            } else {
                prompt = `í˜„ì¬ ${location}ì˜ ê¸°ì˜¨ì´ ${temp}Â°C, ì²´ê°ì˜¨ë„ëŠ” ${feelsLike}Â°C, í’ì†ì€ ${windSpeed}m/sì´ê³ , ë‚ ì”¨ëŠ” '${weather}' ì…ë‹ˆë‹¤. ì´ ë‚ ì”¨ì™€ ëŒ€ê¸°ìƒíƒœë¥¼ ê³ ë ¤í•˜ì—¬ ì˜¤ëŠ˜ í•˜ê¸° ì¢‹ì€ ì¦ê±°ìš´ ì‹¤ë‚´ í™œë™ 2ê°€ì§€ì™€ ì‹¤ì™¸ í™œë™ 1ê°€ì§€ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”. ë‹µë³€ì€ í•œêµ­ì–´ë¡œ, ê° í™œë™ì— ëŒ€í•œ ê°„ë‹¨í•œ ì´ìœ ë¥¼ í¬í•¨í•´ì„œ í•­ëª©ìœ¼ë¡œ êµ¬ë¶„í•´ì¤˜.`;
            }
            getGeminiSuggestion(prompt);
        }

        async function getGeminiSuggestion(prompt) {
            suggestionContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            suggestionResult.classList.add('hidden');
            suggestionResult.innerText = '';
            
            try {
                const response = await fetch('/.netlify/functions/weather', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'gemini', prompt: prompt })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `ì¶”ì²œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
                }

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                    suggestionResult.innerText = result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                    suggestionResult.innerText = `ì£„ì†¡í•©ë‹ˆë‹¤. ìš”ì²­ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ìœ : ${result.promptFeedback.blockReason})\në‹¤ë¥¸ ì§ˆë¬¸ìœ¼ë¡œ ì‹œë„í•´ì£¼ì„¸ìš”.`;
                } else {
                    throw new Error("API ì‘ë‹µì—ì„œ ìœ íš¨í•œ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("Gemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                suggestionResult.innerText = `ì£„ì†¡í•©ë‹ˆë‹¤. ì¶”ì²œì„ ìƒì„±í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (${error.message})`;
            } finally {
                loader.classList.add('hidden');
                suggestionResult.classList.remove('hidden');
            }
        }
    </script>

</body>
</html>